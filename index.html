<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Busca Inteligente de Leis - Carregamento Autom√°tico</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<style>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#f4f4f9; color: #333; }
/* Estilo padr√£o para telas pequenas (vertical) */
.container { 
    max-width: 900px; 
    margin: auto; 
    background: #fff; 
    padding: 20px 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
}

/* üö® NOVO: Media Query para telas horizontais ou tablets (a partir de 600px) */
/* Isso garante que ele use a largura total em modo paisagem */
@media (min-width: 600px) {
    .container {
        max-width: 95%; /* Use 95% da largura da tela */
        padding: 30px 40px; /* Mais espa√ßo nas laterais para telas maiores */
    }
}
/* FIM NOVO */

.controles { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
.campo { display: flex; flex-direction: column; flex: 1; min-width: 250px; }
input, select, button { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; transition: all 0.3s ease; }
input:focus, select:focus { border-color: #007bff; outline: none; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
button { background: #007bff; color: white; border: none; margin-top: 10px; cursor: pointer; font-weight: bold; }
button:hover:not(:disabled) { background: #0056b3; transform: translateY(-1px); }
button:disabled { background: #adb5bd; cursor: not-allowed; }

.resultados, .conteudo-lei { margin-top: 20px; padding: 20px; border: 1px solid #eee; background: #fafafa; border-radius: 4px; }
.loading { text-align: center; font-style: italic; color: #666; }
h1, h2 { color: #0056b3; }
.erro { color: #d9534f; font-weight: bold; }

/* ESTILOS DE ESTRUTURA LEGAL APRIMORADOS */
.resultado-item { 
    margin-bottom: 20px; 
    border-bottom: 1px solid #ddd; 
    padding-bottom: 15px;
    line-height: 1.6;
    text-align: justify;
}
.destaque { 
    font-weight: bold; 
    color: #333; /* Cor mais neutra para legibilidade */
    background: #ffecb3; 
    padding: 1px 0; 
    border-radius: 2px;
}
.artigo-caput { 
    font-weight: bold; 
    margin-bottom: 10px; 
}

/* Base: N√≠vel 0 - Artigo Caput/Par√°grafo comum */
.artigo-caput, .paragrafo-lei {
    padding-left: 0;
    text-indent: 1.5em; /* Recuo padr√£o de par√°grafo */
    margin-bottom: 8px;
}
/* N√≠vel 1: Incisos (Romanos) */
.inciso-lei {
    padding-left: 30px;
    text-indent: -30px; /* Alinha o texto do inciso */
    margin-bottom: 8px;
}
/* N√≠vel 2: Al√≠neas (Letras) */
.alinea-lei {
    padding-left: 60px;
    text-indent: -30px; /* Alinha o texto da al√≠nea */
    margin-bottom: 8px;
}
/* Remove o recuo padr√£o de listas no HTML gerado */
.artigo-conteudo > div {
    margin-top: 5px;
}
</style>
</style>
</head>
<body>
<div class="container">
<h1>Busca Inteligente de Leis</h1>

<div class="controles">
    <div class="campo">
        <label for="inputPDFs">Adicionar mais PDFs:</label>
        <input type="file" id="inputPDFs" multiple accept="application/pdf">
    </div>
    <div class="campo">
        <label for="selecaoLei">Selecione a Lei:</label>
        <select id="selecaoLei"><option value="">Nenhuma lei</option></select>
    </div>
    <div class="campo">
        <label for="inputBusca">Buscar por Palavra:</label>
        <input type="text" id="inputBusca" placeholder="Ex: 'direitos' ou 'impostos'">
        <button id="btnBuscarTexto" disabled>Buscar</button>
    </div>
    <div class="campo">
        <label for="inputArtigo">Buscar por Artigo:</label>
        <input type="text" id="inputArtigo" placeholder="Ex: 5">
        <button id="btnBuscarArtigo" disabled>Buscar Artigo</button>
    </div>
</div>

<div class="resultados" id="resultados"></div>
<div class="conteudo-lei" id="conteudoLei"></div>

</div>

<script>
let leis = [];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

// =================================================================
// üö® ATEN√á√ÉO: EDITAR ESTA LISTA! (Sua lista de arquivos)
// =================================================================
const PDFS_PARA_CARREGAR_AUTOMATICAMENTE = [
    'Constituicao_Federal.pdf', // Exemplo 1
    'Codigo_Civil.pdf', ¬† ¬† ¬† ¬† ¬†// Exemplo 2
    'Del3689 - C√ìDIGO DE PROCESSO PENAL - CPP.pdf',
    'L4737compilado - C√ìDIGO ELEITORAL - CE.pdf',
    'L7492 - CRIMES CONTRA SISTEMA FINANCEIRO NACIONAL.pdf',
    'L7505 - LEI SARNEY - BENEF√çCIOS FISCAIS IRPF PARA CULTURA.pdf',
    'L8313compilada - PROGRAMA NACIONAL DE APOIO √Ä CULTURA - PRONAC.pdf',
    'L8685compilado - MECANISMOS DE FOMENTO √Ä ATIVIDADE AUDIVISUAL.pdf',
    'L9099 - JUIZADOS ESPECIAIS C√çVEIS E CRIMANAIS - JECRIM.pdf',
    'L9296 - LEI INTERCEPA√á√ÉO TELEF√ìNICA.pdf',
    'L9613compilado - CRIMES DE LAVAGEM DE DINHEIRO OU OCULTA√á√ÉO DE BENS.pdf',
    'L9807 - LEI PROTE√á√ÉO ESPECIAL A V√çTIMAS E TESTEMUNHAS.pdf',
    'L10259 - JUIZADOS ESPECIAIS C√çVEIS E CRIMANAIS - JECRIM FEDERAL.pdf',
    'L12850 - LEI ORGANIZA√á√ÉO CRIMINOSA.pdf',
    'Lei n¬∫ 11.343 - LEI DE DROGAS.pdf',
    'Lei n¬∫ 11.343 - SISTEMA NACIONAL DE POL√çTICAS PUBLICAS SOBRE DROGAS - SISNAD.pdf',
    'Fich√°rio1.pdf',
];
// =================================================================


// --- Fun√ß√µes Auxiliares para Estrutura e Destaque ---

function coletarTexto(estrutura) {
    let texto = (estrutura.numero || '') + ' ' + (estrutura.conteudo || '');
    
    if (estrutura.paragrafos) {
        estrutura.paragrafos.forEach(p => texto += ' ' + coletarTexto(p));
    }
    if (estrutura.incisos) {
        estrutura.incisos.forEach(i => texto += ' ' + coletarTexto(i));
    }
    if (estrutura.al√≠neas) {
        estrutura.al√≠neas.forEach(a => texto += ' ' + a.conteudo);
    }
    return texto.replace(/\s+/g, ' ').trim();
}

function destacar(texto, termo) {
    if (!termo) return texto;
    const escapedTermo = termo.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp(`(${escapedTermo})`, 'gi');
    return texto.replace(re, '<span class="destaque">$1</span>');
}

// --- FUN√á√ïES DE FORMATA√á√ÉO CORRIGIDAS ---

function formatarSecao(secao, termo = '') {
    let secaoHtml = '';
    
    // Conte√∫do principal (Artigo, Par√°grafo ou Inciso com n√∫mero)
    if (secao.numero) {
        secaoHtml += `<strong>${secao.numero}</strong> `;
    }
    secaoHtml += `${destacar(secao.conteudo, termo)}`;
    
    // Lista de Incisos (sub-n√≠vel: usa lista de Incisos - Romanos)
    if (secao.incisos && secao.incisos.length > 0) {
        // CORRE√á√ÉO: Estilo Romano Mai√∫sculo
        secaoHtml += `<ul style="list-style-type: upper-roman;">`; 
        secao.incisos.forEach(inciso => {
            secaoHtml += `<li>${formatarSecao(inciso, termo)}</li>`;
        });
        secaoHtml += `</ul>`;
    }
    
    // Lista de Al√≠neas (sub-n√≠vel: usa lista de Al√≠neas - Lower-alpha)
    if (secao.al√≠neas && secao.al√≠neas.length > 0) {
        // CORRE√á√ÉO: Estilo Lower-alpha
        secaoHtml += `<ol style="list-style-type: lower-alpha;">`; 
        secao.al√≠neas.forEach(alinea => {
            secaoHtml += `<li>${destacar(alinea.conteudo, termo)}</li>`;
        });
        secaoHtml += `</ol>`;
    }
    return secaoHtml;
};

function formatarArtigo(artigo, termo = '') {
    let html = `<div class="resultado-item">
        <p><strong>${artigo.numero}</strong> ${destacar(artigo.conteudo, termo)}</p>
    `;

    // Par√°grafos e Incisos diretos do artigo (que s√£o tratados como uma lista)
    if (artigo.paragrafos.length > 0 || artigo.incisos.length > 0) {
        // CORRE√á√ÉO CR√çTICA: Usa list-style-type: none para a lista principal do Artigo,
        // garantindo que n√£o haja "bolinhas" indesejadas nos Incisos e Par√°grafos.
        html += `<ul style="list-style-type: none;">`; 
        
        artigo.paragrafos.forEach(paragrafo => {
            html += `<li>${formatarSecao(paragrafo, termo)}</li>`;
        });
        
        artigo.incisos.forEach(inciso => {
            html += `<li>${formatarSecao(inciso, termo)}</li>`;
        });

        html += `</ul>`; 
    }

    html += `</div>`; 
    return html;
}

// --- FIM FUN√á√ïES DE FORMATA√á√ÉO CORRIGIDAS ---

function limparResultados() {
    document.getElementById('resultados').innerHTML = '';
    document.getElementById('conteudoLei').innerHTML = '';
    document.getElementById('conteudoLei').style.display = 'none';
    document.getElementById('resultados').style.display = 'none';
}

function exibirConteudo(lei, termo = '') {
    const div = document.getElementById('conteudoLei');
    limparResultados();
    div.style.display = 'block';

    if (!lei || !lei.artigos) {
        div.innerHTML = '<p class="erro">N√£o foi poss√≠vel carregar o conte√∫do da lei.</p>';
        return;
    }
    
    let html = `<h2>${lei.nome_lei}</h2>`;
    lei.artigos.forEach(a => html += formatarArtigo(a, termo));
    div.innerHTML = html;
}

function exibirResultados(resultados, termo) {
    const div = document.getElementById('resultados');
    limparResultados();
    div.style.display = 'block';

    if (resultados.length === 0) {
        div.innerHTML = '<p>Nenhuma ocorr√™ncia encontrada.</p>';
        return;
    }

    let html = `<h2>Resultados da Busca por: "${termo}"</h2>`;

    resultados.forEach(r => {
        html += `<h3><span style="color: #007bff;">${r.nome_lei}</span></h3>`;
        r.artigos.forEach(artigo => {
            html += formatarArtigo(artigo, termo);
        });
    });
    
    div.innerHTML = html;
}

function toggleBotoes(habilitar) {
    document.getElementById('btnBuscarTexto').disabled = !habilitar;
    document.getElementById('btnBuscarArtigo').disabled = !habilitar;
    document.getElementById('selecaoLei').disabled = !habilitar;
    document.getElementById('inputBusca').disabled = !habilitar;
    document.getElementById('inputArtigo').disabled = !habilitar;
}

// --- Fun√ß√µes de Processamento Estrutural e PDF (Essenciais) ---
// (As fun√ß√µes abaixo permanecem as mesmas, pois s√£o respons√°veis pela extra√ß√£o)

function estruturarTexto(texto, nomeArquivo) {
    const artigos = [];
    let currentArtigo = null;
    let currentParagrafo = null;
    let currentInciso = null;
    let currentAlinea = null;

    const regexArtigo = /^(Art\.\s*\d+¬∫?)\s*(.*)/i;
    const regexParagrafo = /^(¬ß\s*\d+¬∫?)\s*(.*)|^Par√°grafo\s+√∫nico\s*(.*)/i;
    const regexInciso = /^([IVXLCDM]+\.?)\s*(.*)/i; 
    const regexAlinea = /^([a-z]\))\s*(.*)/i; 

    let linhas = texto.split('\n').map(line => line.trim()).filter(Boolean);
    const linhasLimpo = [];
    for (let i = 0; i < linhas.length; i++) {
        const linhaAtual = linhas[i];
        const proximaLinha = linhas[i + 1];

        const isEstrutural = (str) => regexArtigo.test(str) || regexParagrafo.test(str) || regexInciso.test(str) || regexAlinea.test(str);
        
        if (proximaLinha && !/[.!?:]$/.test(linhaAtual) && !isEstrutural(proximaLinha)) {
            linhas[i + 1] = linhaAtual + ' ' + proximaLinha;
        } else {
            linhasLimpo.push(linhaAtual);
        }
    }
    linhas = linhasLimpo;

    linhas.forEach(linha => {
        let match;

        if (match = linha.match(regexArtigo)) {
            currentArtigo = { numero: match[1], conteudo: match[2] || '', paragrafos: [], incisos: [], texto_completo: '' };
            artigos.push(currentArtigo);
            currentParagrafo = null;
            currentInciso = null;
            currentAlinea = null;
        } else if (match = linha.match(regexParagrafo)) {
            if (currentArtigo) {
                currentParagrafo = { numero: match[1] || 'Par√°grafo √∫nico', conteudo: match[2] || match[3] || '', incisos: [], texto_completo: '' };
                currentArtigo.paragrafos.push(currentParagrafo);
                currentInciso = null;
                currentAlinea = null;
            }
        } else if (match = linha.match(regexInciso)) {
            const novoInciso = { numero: match[1], conteudo: match[2] || '', al√≠neas: [], texto_completo: '' };

            if (currentParagrafo) {
                currentInciso = novoInciso;
                currentParagrafo.incisos.push(currentInciso);
            } else if (currentArtigo) {
                currentInciso = novoInciso;
                currentArtigo.incisos.push(currentInciso);
            }
            currentAlinea = null;
        } else if (match = linha.match(regexAlinea)) {
            const novaAlinea = { conteudo: match[0], texto_completo: '' };
            
            if (currentInciso) {
                currentAlinea = novaAlinea;
                currentInciso.al√≠neas.push(novaAlinea);
            } else if (currentArtigo) {
                 const target = currentParagrafo || currentArtigo;
                 if (target.incisos.length === 0 || target.incisos[target.incisos.length - 1].numero !== '') {
                     currentInciso = { numero: '', conteudo: '', al√≠neas: [], texto_completo: '' };
                     target.incisos.push(currentInciso);
                 } else {
                     currentInciso = target.incisos[target.incisos.length - 1];
                 }
                 currentAlinea = novaAlinea;
                 currentInciso.al√≠neas.push(novaAlinea);
            }
        } else {
            if (currentAlinea) {
                currentAlinea.conteudo += ' ' + linha;
            } else if (currentInciso) {
                currentInciso.conteudo += ' ' + linha;
            } else if (currentParagrafo) {
                currentParagrafo.conteudo += ' ' + linha;
            } else if (currentArtigo) {
                currentArtigo.conteudo += ' ' + linha;
            }
        }
    });

    // Pr√©-processamento de texto completo para busca
    artigos.forEach(art => {
        art.conteudo = art.conteudo.replace(/\s+/g, ' ').trim();
        art.paragrafos.forEach(p => {
            p.conteudo = p.conteudo.replace(/\s+/g, ' ').trim();
            p.incisos.forEach(i => {
                i.conteudo = i.conteudo.replace(/\s+/g, ' ').trim();
                i.al√≠neas.forEach(a => a.conteudo = a.conteudo.replace(/\s+/g, ' ').trim());
                i.texto_completo = coletarTexto(i);
            });
            p.texto_completo = coletarTexto(p);
        });

        art.incisos.forEach(i => {
            i.conteudo = i.conteudo.replace(/\s+/g, ' ').trim();
            i.al√≠neas.forEach(a => a.conteudo = a.conteudo.replace(/\s+/g, ' ').trim());
            i.texto_completo = coletarTexto(i);
        });

        art.texto_completo = coletarTexto(art);
    });

    return { nome_lei: nomeArquivo.replace(/\.pdf$/i, ''), artigos };
}

async function processarPDF(fileOrUrl, isUrl = false) {
    let pdfData;
    let fileName;

    if (isUrl) {
        fileName = fileOrUrl;
        try {
            const response = await fetch(fileOrUrl);
            // IMPORTANTE: Isso s√≥ funcionar√° se voc√™ estiver usando um servidor local (como Live Server)
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            pdfData = await response.arrayBuffer();
        } catch (error) {
            console.error(`Falha ao carregar o PDF: ${fileOrUrl}. Certifique-se de estar rodando em um servidor local.`, error);
            return null;
        }
    } else {
        fileName = fileOrUrl.name;
        pdfData = await fileOrUrl.arrayBuffer();
    }
    
    // Agora processa o buffer do PDF
    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
    let textoCompleto = '';
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join('\n');
        textoCompleto += pageText + '\n\n'; 
    }
    return estruturarTexto(textoCompleto, fileName);
}


// -----------------------------------------------------------------
// FUN√á√ÉO DE CARREGAMENTO AUTOM√ÅTICO
// -----------------------------------------------------------------
async function carregarPDFsAutomaticamente() {
    toggleBotoes(false);
    const selecaoLei = document.getElementById('selecaoLei');
    const resultadosDiv = document.getElementById('resultados');
    
    selecaoLei.innerHTML = '<option value="">Aguarde, carregando leis...</option>';
    resultadosDiv.innerHTML = '<p class="loading">Iniciando carregamento de arquivos...</p>';
    resultadosDiv.style.display = 'block';
    
    let leisCarregadasComSucesso = 0;

    for (const fileName of PDFS_PARA_CARREGAR_AUTOMATICAMENTE) {
        resultadosDiv.innerHTML = `<p class="loading">Processando: ${fileName}...</p>`;
        const lei = await processarPDF(fileName, true);
        
        if (lei) {
            leis.push(lei);
            leisCarregadasComSucesso++;
            // Adiciona ao dropdown
            const option = document.createElement('option');
            option.value = lei.nome_lei;
            option.textContent = lei.nome_lei;
            selecaoLei.appendChild(option);
        } else {
            resultadosDiv.innerHTML += `<p class="erro">Falha ao carregar ${fileName}. Verifique o nome do arquivo e se est√° no mesmo diret√≥rio.</p>`;
        }
    }

    selecaoLei.querySelector('option').textContent = "Selecione uma lei";

    if (leisCarregadasComSucesso > 0) {
        resultadosDiv.innerHTML = `<p>Carregamento autom√°tico conclu√≠do. ${leisCarregadasComSucesso} lei(s) pronta(s) para busca.</p>`;
        toggleBotoes(true);
    } else {
        resultadosDiv.innerHTML = '<p class="erro">Nenhuma lei carregada automaticamente. Verifique se os arquivos est√£o na pasta raiz e se voc√™ est√° usando um servidor local.</p>';
        toggleBotoes(false);
    }
}


// --- Eventos ---

document.getElementById('inputPDFs').addEventListener('change', async e => {
    toggleBotoes(false);
    const files = Array.from(e.target.files);
    
    if (files.length === 0) {
        if (leis.length > 0) toggleBotoes(true);
        return;
    }

    const selecaoLei = document.getElementById('selecaoLei');
    const resultadosDiv = document.getElementById('resultados');
    resultadosDiv.innerHTML = '<p class="loading">Processando uploads...</p>';

    let novasLeis = [];
    for (const f of files) {
        try {
            const lei = await processarPDF(f, false);
            if (lei) novasLeis.push(lei);
        } catch (error) {
             resultadosDiv.innerHTML += `<p class="erro">Erro ao processar ${f.name}.</p>`;
        }
    }
    
    leis = [...leis, ...novasLeis];

    if (novasLeis.length > 0) {
        novasLeis.forEach(lei => {
            const option = document.createElement('option');
            option.value = lei.nome_lei;
            option.textContent = lei.nome_lei;
            selecaoLei.appendChild(option);
        });
        resultadosDiv.innerHTML = `<p>${novasLeis.length} lei(s) adicionada(s) via upload.</p>`;
    } else {
        resultadosDiv.innerHTML = '<p class="erro">Nenhuma lei processada com sucesso via upload.</p>';
    }
    toggleBotoes(leis.length > 0);
});


document.getElementById('selecaoLei').addEventListener('change', e => {
    const nome = e.target.value;
    if (nome === "") {
        limparResultados();
        return;
    }
    const lei = leis.find(l => l.nome_lei === nome);
    exibirConteudo(lei, document.getElementById('inputBusca').value.trim());
});

document.getElementById('btnBuscarTexto').addEventListener('click', () => {
    const termo = document.getElementById('inputBusca').value.trim();
    if (!termo) {
        alert('Por favor, digite um termo para buscar.');
        return;
    }
    
    const nomeLeiSelecionada = document.getElementById('selecaoLei').value;

    const leisParaBuscar = nomeLeiSelecionada ? 
        [leis.find(l => l.nome_lei === nomeLeiSelecionada)].filter(Boolean) : 
        leis;

    const resultados = [];
    
    leisParaBuscar.forEach(lei => {
        if (!lei || !lei.artigos) return;
        const artigosFiltrados = lei.artigos.filter(artigo => {
            return artigo.texto_completo.toLowerCase().includes(termo.toLowerCase());
        });

        if (artigosFiltrados.length > 0) {
            const artigosParaExibir = artigosFiltrados.map(art => ({ ...art }));
            resultados.push({ nome_lei: lei.nome_lei, artigos: artigosParaExibir });
        }
    });

    exibirResultados(resultados, termo);
});

document.getElementById('btnBuscarArtigo').addEventListener('click', () => {
    const numeroArtigoInput = document.getElementById('inputArtigo').value.trim();
    const nomeLeiSelecionada = document.getElementById('selecaoLei').value;
    
    if (!numeroArtigoInput || !nomeLeiSelecionada) {
        alert('Por favor, selecione uma lei e digite o n√∫mero do artigo.');
        return;
    }

    const numeroArtigoNormalizado = numeroArtigoInput.replace(/\D/g, '').trim();

    const leiSelecionada = leis.find(l => l.nome_lei === nomeLeiSelecionada);
    if (!leiSelecionada || !leiSelecionada.artigos) {
        alert('Lei n√£o encontrada ou sem conte√∫do.');
        return;
    }

    const artigoEncontrado = leiSelecionada.artigos.find(a => {
        const numeroLimpo = a.numero.replace(/\D/g, '').trim();
        return numeroLimpo === numeroArtigoNormalizado;
    });

    const termoBusca = document.getElementById('inputBusca').value.trim();
    
    if (artigoEncontrado) {
        exibirConteudo({
            nome_lei: leiSelecionada.nome_lei,
            artigos: [artigoEncontrado]
        }, termoBusca);
    } else {
        const resultadosDiv = document.getElementById('resultados');
        limparResultados();
        resultadosDiv.innerHTML = `<p class="erro">Artigo ${numeroArtigoInput} n√£o encontrado na lei ${leiSelecionada.nome_lei}.</p>`;
        resultadosDiv.style.display = 'block';
    }
});

// Inicia o carregamento autom√°tico ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', carregarPDFsAutomaticamente);
</script>
</body>
</html>
